---
import BaseLayout from '../../layouts/BaseLayout.astro';
import DashboardLayout from '../../layouts/DashboardLayout.astro';
import Card from '../../components/ui/Card.astro';
import Button from '../../components/ui/Button.astro';
---

<BaseLayout title="Thêm khách hàng - ComputerPOS Pro">
  <DashboardLayout>
    <main class="p-6 space-y-6">
      <!-- Header -->
      <div class="flex justify-between items-center">
        <div>
          <h1 class="text-3xl font-bold text-gray-900">Thêm khách hàng mới</h1>
          <p class="text-gray-600 mt-1">Thêm thông tin khách hàng vào hệ thống</p>
        </div>
        <div class="flex space-x-3">
          <Button href="/customers" variant="secondary">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m0 7h18" />
            </svg>
            Quay lại
          </Button>
          <Button variant="primary" id="save-customer">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
            </svg>
            Lưu khách hàng
          </Button>
        </div>
      </div>

      <form id="customer-form" class="space-y-6">
        <!-- Basic Information -->
        <Card>
          <div class="p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Thông tin cơ bản</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Họ và tên *</label>
                <input
                  type="text"
                  name="full_name"
                  required
                  minlength="2"
                  maxlength="100"
                  pattern="[a-zA-ZÀ-ỹ\s]+"
                  title="Họ tên chỉ được chứa chữ cái và khoảng trắng"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  placeholder="VD: Nguyễn Văn A"
                />
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Số điện thoại *</label>
                <input
                  type="tel"
                  name="phone"
                  required
                  pattern="[0-9]{10,11}"
                  minlength="10"
                  maxlength="11"
                  title="Số điện thoại phải có 10-11 chữ số"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  placeholder="VD: 0901234567"
                />
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                <input
                  type="email"
                  name="email"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  placeholder="VD: customer@email.com"
                />
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Ngày sinh</label>
                <input
                  type="date"
                  name="birth_date"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                />
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Giới tính</label>
                <select
                  name="gender"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                >
                  <option value="">Chọn giới tính</option>
                  <option value="male">Nam</option>
                  <option value="female">Nữ</option>
                  <option value="other">Khác</option>
                </select>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Loại khách hàng</label>
                <select
                  name="customer_type"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                >
                  <option value="individual">Cá nhân</option>
                  <option value="business">Doanh nghiệp</option>
                  <option value="vip">VIP</option>
                </select>
              </div>
            </div>
          </div>
        </Card>

        <!-- Address Information -->
        <Card>
          <div class="p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Địa chỉ</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-2">Địa chỉ chi tiết</label>
                <input
                  type="text"
                  name="address"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  placeholder="VD: 123 Đường ABC, Phường XYZ"
                />
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Quận/Huyện</label>
                <select
                  name="district"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                >
                  <option value="">Chọn quận/huyện</option>
                  <option value="quan1">Quận 1</option>
                  <option value="quan2">Quận 2</option>
                  <option value="quan3">Quận 3</option>
                  <option value="quan4">Quận 4</option>
                  <option value="quan5">Quận 5</option>
                  <option value="quan6">Quận 6</option>
                  <option value="quan7">Quận 7</option>
                  <option value="quan8">Quận 8</option>
                  <option value="quan9">Quận 9</option>
                  <option value="quan10">Quận 10</option>
                  <option value="quan11">Quận 11</option>
                  <option value="quan12">Quận 12</option>
                  <option value="binhtan">Bình Tân</option>
                  <option value="binhthanh">Bình Thạnh</option>
                  <option value="govap">Gò Vấp</option>
                  <option value="phunhuan">Phú Nhuận</option>
                  <option value="tanbinh">Tân Bình</option>
                  <option value="tanphu">Tân Phú</option>
                  <option value="thuduc">Thủ Đức</option>
                </select>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Thành phố</label>
                <select
                  name="city"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                >
                  <option value="hcm">TP. Hồ Chí Minh</option>
                  <option value="hanoi">Hà Nội</option>
                  <option value="danang">Đà Nẵng</option>
                  <option value="cantho">Cần Thơ</option>
                  <option value="haiphong">Hải Phòng</option>
                </select>
              </div>
            </div>
          </div>
        </Card>

        <!-- Business Information (for business customers) -->
        <Card id="business-info" class="hidden">
          <div class="p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Thông tin doanh nghiệp</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Tên công ty</label>
                <input
                  type="text"
                  name="company_name"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  placeholder="VD: Công ty TNHH ABC"
                />
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Mã số thuế</label>
                <input
                  type="text"
                  name="tax_code"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  placeholder="VD: 0123456789"
                />
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Người đại diện</label>
                <input
                  type="text"
                  name="representative"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  placeholder="VD: Nguyễn Văn B"
                />
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Chức vụ</label>
                <input
                  type="text"
                  name="position"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  placeholder="VD: Giám đốc"
                />
              </div>
            </div>
          </div>
        </Card>

        <!-- Additional Information -->
        <Card>
          <div class="p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Thông tin bổ sung</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Nguồn khách hàng</label>
                <select
                  name="source"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                >
                  <option value="">Chọn nguồn</option>
                  <option value="website">Website</option>
                  <option value="facebook">Facebook</option>
                  <option value="google">Google</option>
                  <option value="referral">Giới thiệu</option>
                  <option value="walk-in">Khách vãng lai</option>
                  <option value="other">Khác</option>
                </select>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Mức độ ưu tiên</label>
                <select
                  name="priority"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                >
                  <option value="normal">Bình thường</option>
                  <option value="high">Cao</option>
                  <option value="vip">VIP</option>
                </select>
              </div>

              <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-2">Ghi chú</label>
                <textarea
                  name="notes"
                  rows="4"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  placeholder="Ghi chú thêm về khách hàng..."
                ></textarea>
              </div>
            </div>
          </div>
        </Card>
      </form>
    </main>
  </DashboardLayout>
</BaseLayout>

<script>
  // Customer form functionality
  document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('customer-form');
    const saveButton = document.getElementById('save-customer');
    const customerTypeSelect = form?.querySelector('select[name="customer_type"]');
    const businessInfo = document.getElementById('business-info');

    // Show/hide business info based on customer type
    customerTypeSelect?.addEventListener('change', function() {
      if (this.value === 'business') {
        businessInfo?.classList.remove('hidden');
        // Make business fields required
        const businessFields = businessInfo?.querySelectorAll('input[name="company_name"], input[name="tax_code"]');
        businessFields?.forEach(field => field.required = true);
      } else {
        businessInfo?.classList.add('hidden');
        // Remove required from business fields
        const businessFields = businessInfo?.querySelectorAll('input');
        businessFields?.forEach(field => field.required = false);
      }
    });

    // Save customer
    saveButton?.addEventListener('click', function(e) {
      e.preventDefault();

      if (!form?.checkValidity()) {
        form?.reportValidity();
        return;
      }

      // Show loading state
      saveButton.disabled = true;
      saveButton.innerHTML = `
        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        Đang lưu...
      `;

      // Collect form data
      const formData = new FormData(form);
      const customerData = Object.fromEntries(formData.entries());

      // Simulate API call
      setTimeout(() => {
        try {
          console.log('Customer data:', customerData);

          // Simulate random error (5% chance)
          if (Math.random() < 0.05) {
            throw new Error('Lỗi kết nối server');
          }

          alert('Khách hàng đã được lưu thành công!');

          // Redirect to customers list
          window.location.href = '/customers';
        } catch (error) {
          // Reset button
          saveButton.disabled = false;
          saveButton.innerHTML = `
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
            </svg>
            Lưu khách hàng
          `;

          alert(`Lỗi: ${error.message}. Vui lòng thử lại.`);
        }
      }, 1500);
    });

    // Phone number formatting
    const phoneInput = form?.querySelector('input[name="phone"]');
    phoneInput?.addEventListener('input', function(e) {
      // Remove non-digits
      let value = e.target.value.replace(/\D/g, '');

      // Limit to 11 digits
      if (value.length > 11) {
        value = value.slice(0, 11);
      }

      e.target.value = value;
    });

    // Auto-generate customer ID
    const nameInput = form?.querySelector('input[name="full_name"]');
    nameInput?.addEventListener('blur', function() {
      // In real app, would generate customer ID based on name and timestamp
      console.log('Auto-generating customer ID for:', this.value);
    });
  });
</script>