---
import BaseLayout from '../../layouts/BaseLayout.astro';
import DashboardLayout from '../../layouts/DashboardLayout.astro';
import Card from '../../components/ui/Card.astro';
import Button from '../../components/ui/Button.astro';
---

<BaseLayout title="Warranty Management - ComputerPOS Pro">
  <DashboardLayout>
    <main class="p-6 space-y-6">
      <!-- Header -->
      <div class="flex justify-between items-center">
        <div>
          <h1 class="text-3xl font-bold text-gray-900">Warranty Management</h1>
          <p class="text-gray-600 mt-1">Quản lý bảo hành và chăm sóc khách hàng</p>
        </div>
        <div class="flex space-x-3">
          <Button href="/inventory" variant="secondary">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
            Quay lại Kho hàng
          </Button>
          <Button variant="primary" onclick="createNewWarranty()">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
            </svg>
            Tạo yêu cầu bảo hành
          </Button>
        </div>
      </div>

      <!-- Warranty Stats -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <Card>
          <div class="p-6">
            <div class="flex items-center">
              <div class="flex-shrink-0">
                <div class="w-8 h-8 bg-blue-500 rounded-md flex items-center justify-center">
                  <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                  </svg>
                </div>
              </div>
              <div class="ml-5 w-0 flex-1">
                <dl>
                  <dt class="text-sm font-medium text-gray-500 truncate">Tổng yêu cầu</dt>
                  <dd class="text-lg font-medium text-gray-900" id="total-warranties">0</dd>
                </dl>
              </div>
            </div>
          </div>
        </Card>

        <Card>
          <div class="p-6">
            <div class="flex items-center">
              <div class="flex-shrink-0">
                <div class="w-8 h-8 bg-yellow-500 rounded-md flex items-center justify-center">
                  <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                </div>
              </div>
              <div class="ml-5 w-0 flex-1">
                <dl>
                  <dt class="text-sm font-medium text-gray-500 truncate">Đang xử lý</dt>
                  <dd class="text-lg font-medium text-gray-900" id="pending-warranties">0</dd>
                </dl>
              </div>
            </div>
          </div>
        </Card>

        <Card>
          <div class="p-6">
            <div class="flex items-center">
              <div class="flex-shrink-0">
                <div class="w-8 h-8 bg-green-500 rounded-md flex items-center justify-center">
                  <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                  </svg>
                </div>
              </div>
              <div class="ml-5 w-0 flex-1">
                <dl>
                  <dt class="text-sm font-medium text-gray-500 truncate">Hoàn thành</dt>
                  <dd class="text-lg font-medium text-gray-900" id="completed-warranties">0</dd>
                </dl>
              </div>
            </div>
          </div>
        </Card>

        <Card>
          <div class="p-6">
            <div class="flex items-center">
              <div class="flex-shrink-0">
                <div class="w-8 h-8 bg-purple-500 rounded-md flex items-center justify-center">
                  <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                  </svg>
                </div>
              </div>
              <div class="ml-5 w-0 flex-1">
                <dl>
                  <dt class="text-sm font-medium text-gray-500 truncate">Thời gian TB</dt>
                  <dd class="text-lg font-medium text-gray-900" id="avg-time">0 ngày</dd>
                </dl>
              </div>
            </div>
          </div>
        </Card>
      </div>

      <!-- Warranty Chart -->
      <Card>
        <div class="p-6">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-lg font-medium text-gray-900">Thống kê bảo hành theo thời gian</h2>
            <div class="flex space-x-3">
              <select class="form-select w-40" id="chart-period">
                <option value="7">7 ngày qua</option>
                <option value="30">30 ngày qua</option>
                <option value="90">3 tháng qua</option>
                <option value="365">1 năm qua</option>
              </select>
            </div>
          </div>
          
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2">
              <canvas id="warranty-chart" width="600" height="300"></canvas>
            </div>
            <div>
              <h3 class="text-md font-medium text-gray-900 mb-4">Sản phẩm bảo hành nhiều nhất</h3>
              <div class="space-y-3" id="top-warranty-products">
                <!-- Top warranty products will be populated here -->
              </div>
            </div>
          </div>
        </div>
      </Card>

      <!-- Filters and Search -->
      <Card>
        <div class="p-6">
          <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
            <div>
              <label class="form-label">Tìm kiếm</label>
              <input type="text" class="form-input" id="search-input" placeholder="Mã bảo hành, khách hàng...">
            </div>
            <div>
              <label class="form-label">Trạng thái</label>
              <select class="form-select" id="status-filter">
                <option value="all">Tất cả</option>
                <option value="pending">Chờ xử lý</option>
                <option value="approved">Đã duyệt</option>
                <option value="in-progress">Đang sửa chữa</option>
                <option value="completed">Hoàn thành</option>
                <option value="rejected">Từ chối</option>
                <option value="cancelled">Đã hủy</option>
              </select>
            </div>
            <div>
              <label class="form-label">Loại sản phẩm</label>
              <select class="form-select" id="product-filter">
                <option value="all">Tất cả</option>
                <option value="laptop">Laptop</option>
                <option value="desktop">Desktop PC</option>
                <option value="cpu">CPU</option>
                <option value="gpu">VGA Card</option>
                <option value="ram">RAM</option>
                <option value="storage">Ổ cứng</option>
                <option value="monitor">Màn hình</option>
                <option value="peripherals">Phụ kiện</option>
              </select>
            </div>
            <div>
              <label class="form-label">Mức độ ưu tiên</label>
              <select class="form-select" id="priority-filter">
                <option value="all">Tất cả</option>
                <option value="low">Thấp</option>
                <option value="normal">Bình thường</option>
                <option value="high">Cao</option>
                <option value="urgent">Khẩn cấp</option>
              </select>
            </div>
            <div>
              <label class="form-label">Khoảng thời gian</label>
              <select class="form-select" id="date-filter">
                <option value="7">7 ngày qua</option>
                <option value="30">30 ngày qua</option>
                <option value="90">3 tháng qua</option>
                <option value="365">1 năm qua</option>
                <option value="custom">Tùy chọn</option>
              </select>
            </div>
          </div>
          <div id="custom-date-range" class="hidden mt-4 grid grid-cols-2 gap-4">
            <div>
              <label class="form-label">Từ ngày</label>
              <input type="date" class="form-input" id="start-date">
            </div>
            <div>
              <label class="form-label">Đến ngày</label>
              <input type="date" class="form-input" id="end-date">
            </div>
          </div>
        </div>
      </Card>

      <!-- Warranties List -->
      <Card>
        <div class="p-6">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-lg font-medium text-gray-900">Danh sách yêu cầu bảo hành</h2>
            <div class="flex space-x-3">
              <Button onclick="exportWarranties()" variant="secondary">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                Xuất báo cáo
              </Button>
              <Button onclick="refreshWarranties()" variant="secondary">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
                Làm mới
              </Button>
            </div>
          </div>

          <div class="overflow-hidden shadow ring-1 ring-black ring-opacity-5 md:rounded-lg">
            <table class="min-w-full divide-y divide-gray-300">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mã bảo hành</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Khách hàng</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sản phẩm</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vấn đề</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ưu tiên</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Trạng thái</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ngày tạo</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Thao tác</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200" id="warranties-tbody">
                <!-- Warranties will be populated here -->
              </tbody>
            </table>
          </div>
        </div>
      </Card>
    </main>

    <!-- Create Warranty Modal -->
    <div id="warranty-modal" class="modal-overlay hidden">
      <div class="modal-content max-w-4xl">
        <div class="modal-header">
          <h3 class="modal-title">Tạo yêu cầu bảo hành mới</h3>
          <button class="modal-close" onclick="closeModal('warranty-modal')">&times;</button>
        </div>
        <div class="modal-body">
          <div class="space-y-6">
            <!-- Basic Information -->
            <div>
              <h4 class="text-md font-medium text-gray-900 mb-4">Thông tin cơ bản</h4>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="form-label">Mã bảo hành *</label>
                  <input type="text" class="form-input" id="warranty-code" placeholder="WTY-001" readonly>
                </div>
                <div>
                  <label class="form-label">Mức độ ưu tiên *</label>
                  <select class="form-select" id="warranty-priority">
                    <option value="normal">Bình thường</option>
                    <option value="low">Thấp</option>
                    <option value="high">Cao</option>
                    <option value="urgent">Khẩn cấp</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Customer Information -->
            <div>
              <h4 class="text-md font-medium text-gray-900 mb-4">Thông tin khách hàng</h4>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="form-label">Tên khách hàng *</label>
                  <input type="text" class="form-input" id="customer-name" placeholder="Họ tên khách hàng...">
                </div>
                <div>
                  <label class="form-label">Số điện thoại *</label>
                  <input type="tel" class="form-input" id="customer-phone" placeholder="0123456789">
                </div>
                <div>
                  <label class="form-label">Email</label>
                  <input type="email" class="form-input" id="customer-email" placeholder="email@example.com">
                </div>
                <div>
                  <label class="form-label">Địa chỉ</label>
                  <input type="text" class="form-input" id="customer-address" placeholder="Địa chỉ khách hàng...">
                </div>
              </div>
            </div>

            <!-- Product Information -->
            <div>
              <h4 class="text-md font-medium text-gray-900 mb-4">Thông tin sản phẩm</h4>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <label class="form-label">Tên sản phẩm *</label>
                  <input type="text" class="form-input" id="product-name" placeholder="Tên sản phẩm...">
                </div>
                <div>
                  <label class="form-label">Model/SKU</label>
                  <input type="text" class="form-input" id="product-model" placeholder="Model sản phẩm...">
                </div>
                <div>
                  <label class="form-label">Serial Number</label>
                  <input type="text" class="form-input" id="product-serial" placeholder="Số seri...">
                </div>
                <div>
                  <label class="form-label">Loại sản phẩm</label>
                  <select class="form-select" id="product-category">
                    <option value="laptop">Laptop</option>
                    <option value="desktop">Desktop PC</option>
                    <option value="cpu">CPU</option>
                    <option value="gpu">VGA Card</option>
                    <option value="ram">RAM</option>
                    <option value="storage">Ổ cứng</option>
                    <option value="monitor">Màn hình</option>
                    <option value="peripherals">Phụ kiện</option>
                  </select>
                </div>
                <div>
                  <label class="form-label">Ngày mua</label>
                  <input type="date" class="form-input" id="purchase-date">
                </div>
                <div>
                  <label class="form-label">Hết hạn bảo hành</label>
                  <input type="date" class="form-input" id="warranty-expiry">
                </div>
              </div>
            </div>

            <!-- Problem Description -->
            <div>
              <h4 class="text-md font-medium text-gray-900 mb-4">Mô tả vấn đề</h4>
              <div class="space-y-4">
                <div>
                  <label class="form-label">Vấn đề gặp phải *</label>
                  <textarea class="form-textarea" id="problem-description" rows="4" placeholder="Mô tả chi tiết vấn đề gặp phải..."></textarea>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label class="form-label">Tình trạng sản phẩm</label>
                    <select class="form-select" id="product-condition">
                      <option value="good">Tốt</option>
                      <option value="fair">Khá</option>
                      <option value="poor">Kém</option>
                      <option value="damaged">Hỏng nặng</option>
                    </select>
                  </div>
                  <div>
                    <label class="form-label">Tần suất xảy ra</label>
                    <select class="form-select" id="issue-frequency">
                      <option value="always">Luôn luôn</option>
                      <option value="frequent">Thường xuyên</option>
                      <option value="sometimes">Thỉnh thoảng</option>
                      <option value="rare">Hiếm khi</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>

            <input type="hidden" id="warranty-id">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal('warranty-modal')">Hủy</button>
          <button type="button" class="btn btn-primary" onclick="saveWarranty()">Tạo yêu cầu</button>
        </div>
      </div>
    </div>

    <!-- View Warranty Detail Modal -->
    <div id="warranty-detail-modal" class="modal-overlay hidden">
      <div class="modal-content max-w-5xl">
        <div class="modal-header">
          <h3 class="modal-title" id="warranty-detail-title">Chi tiết yêu cầu bảo hành</h3>
          <button class="modal-close" onclick="closeModal('warranty-detail-modal')">&times;</button>
        </div>
        <div class="modal-body">
          <div id="warranty-detail-content">
            <!-- Warranty details will be populated here -->
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal('warranty-detail-modal')">Đóng</button>
          <button type="button" class="btn btn-success" id="approve-warranty-btn">Duyệt yêu cầu</button>
          <button type="button" class="btn btn-primary" id="update-status-btn">Cập nhật trạng thái</button>
        </div>
      </div>
    </div>

    <!-- Update Status Modal -->
    <div id="update-status-modal" class="modal-overlay hidden">
      <div class="modal-content max-w-2xl">
        <div class="modal-header">
          <h3 class="modal-title">Cập nhật trạng thái bảo hành</h3>
          <button class="modal-close" onclick="closeModal('update-status-modal')">&times;</button>
        </div>
        <div class="modal-body">
          <div class="space-y-4">
            <div>
              <label class="form-label">Trạng thái mới *</label>
              <select class="form-select" id="new-status">
                <option value="approved">Đã duyệt</option>
                <option value="in-progress">Đang sửa chữa</option>
                <option value="completed">Hoàn thành</option>
                <option value="rejected">Từ chối</option>
                <option value="cancelled">Đã hủy</option>
              </select>
            </div>
            <div>
              <label class="form-label">Ghi chú cập nhật *</label>
              <textarea class="form-textarea" id="status-notes" rows="4" placeholder="Ghi chú về việc cập nhật trạng thái..."></textarea>
            </div>
            <div id="completion-fields" class="hidden space-y-4">
              <div>
                <label class="form-label">Chi phí sửa chữa</label>
                <input type="number" class="form-input" id="repair-cost" placeholder="0">
              </div>
              <div>
                <label class="form-label">Linh kiện đã thay</label>
                <textarea class="form-textarea" id="replaced-parts" rows="2" placeholder="Danh sách linh kiện đã thay thế..."></textarea>
              </div>
            </div>
            <input type="hidden" id="updating-warranty-id">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal('update-status-modal')">Hủy</button>
          <button type="button" class="btn btn-primary" onclick="submitStatusUpdate()">Cập nhật</button>
        </div>
      </div>
    </div>
  </DashboardLayout>
</BaseLayout>

<script>
document.addEventListener('DOMContentLoaded', function() {
  let warranties = [];
  let currentWarranty = null;

  // Load sample data
  function loadSampleData() {
    warranties = JSON.parse(localStorage.getItem('warranties') || '[]');

    // Initialize with sample data if empty
    if (warranties.length === 0) {
      warranties = [
        {
          id: 'wty_1',
          code: 'WTY-001',
          customerName: 'Nguyễn Văn An',
          customerPhone: '0987654321',
          customerEmail: 'an.nguyen@email.com',
          customerAddress: '123 Đường ABC, Q1, TP.HCM',
          productName: 'Laptop ASUS ROG Strix G15',
          productModel: 'G513QM-HN015W',
          productSerial: 'M3NXCX123456',
          productCategory: 'laptop',
          purchaseDate: '2024-01-15',
          warrantyExpiry: '2026-01-15',
          problemDescription: 'Laptop bị tắt đột ngột khi chạy game, có tiếng kêu lạ từ quạt tản nhiệt',
          productCondition: 'fair',
          issueFrequency: 'frequent',
          priority: 'high',
          status: 'pending',
          createdAt: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString(),
          createdBy: 'Admin User',
          statusHistory: [
            {
              status: 'pending',
              timestamp: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString(),
              notes: 'Yêu cầu bảo hành được tạo',
              updatedBy: 'Admin User'
            }
          ]
        },
        {
          id: 'wty_2',
          code: 'WTY-002',
          customerName: 'Trần Thị Bình',
          customerPhone: '0912345678',
          customerEmail: 'binh.tran@email.com',
          customerAddress: '456 Đường XYZ, Q3, TP.HCM',
          productName: 'VGA MSI RTX 4070',
          productModel: 'RTX4070-GAMING-X-12G',
          productSerial: 'MSI123456789',
          productCategory: 'gpu',
          purchaseDate: '2024-03-20',
          warrantyExpiry: '2027-03-20',
          problemDescription: 'Card đồ họa bị artifact khi chạy game, nhiệt độ tăng cao bất thường',
          productCondition: 'good',
          issueFrequency: 'sometimes',
          priority: 'normal',
          status: 'in-progress',
          createdAt: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString(),
          createdBy: 'Nhân viên A',
          approvedAt: new Date(Date.now() - 4 * 24 * 60 * 60 * 1000).toISOString(),
          approvedBy: 'Manager',
          statusHistory: [
            {
              status: 'pending',
              timestamp: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString(),
              notes: 'Yêu cầu bảo hành được tạo',
              updatedBy: 'Nhân viên A'
            },
            {
              status: 'approved',
              timestamp: new Date(Date.now() - 4 * 24 * 60 * 60 * 1000).toISOString(),
              notes: 'Đã duyệt yêu cầu bảo hành',
              updatedBy: 'Manager'
            },
            {
              status: 'in-progress',
              timestamp: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toISOString(),
              notes: 'Bắt đầu kiểm tra và sửa chữa',
              updatedBy: 'Kỹ thuật viên'
            }
          ]
        },
        {
          id: 'wty_3',
          code: 'WTY-003',
          customerName: 'Lê Văn Cường',
          customerPhone: '0923456789',
          customerEmail: 'cuong.le@email.com',
          customerAddress: '789 Đường DEF, Q7, TP.HCM',
          productName: 'SSD Samsung 980 Pro 1TB',
          productModel: 'MZ-V8P1T0BW',
          productSerial: 'S5GXNF0R123456',
          productCategory: 'storage',
          purchaseDate: '2023-11-10',
          warrantyExpiry: '2028-11-10',
          problemDescription: 'SSD không được nhận diện, hệ thống không boot được',
          productCondition: 'poor',
          issueFrequency: 'always',
          priority: 'urgent',
          status: 'completed',
          createdAt: new Date(Date.now() - 10 * 24 * 60 * 60 * 1000).toISOString(),
          createdBy: 'Nhân viên B',
          completedAt: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString(),
          repairCost: 0,
          replacedParts: 'Thay thế SSD mới cùng model',
          statusHistory: [
            {
              status: 'pending',
              timestamp: new Date(Date.now() - 10 * 24 * 60 * 60 * 1000).toISOString(),
              notes: 'Yêu cầu bảo hành được tạo',
              updatedBy: 'Nhân viên B'
            },
            {
              status: 'approved',
              timestamp: new Date(Date.now() - 9 * 24 * 60 * 60 * 1000).toISOString(),
              notes: 'Duyệt yêu cầu bảo hành',
              updatedBy: 'Manager'
            },
            {
              status: 'in-progress',
              timestamp: new Date(Date.now() - 8 * 24 * 60 * 60 * 1000).toISOString(),
              notes: 'Bắt đầu kiểm tra SSD',
              updatedBy: 'Kỹ thuật viên'
            },
            {
              status: 'completed',
              timestamp: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString(),
              notes: 'Đã thay thế SSD mới. Khách hàng hài lòng.',
              updatedBy: 'Kỹ thuật viên'
            }
          ]
        },
        {
          id: 'wty_4',
          code: 'WTY-004',
          customerName: 'Phạm Thị Dung',
          customerPhone: '0934567890',
          customerEmail: 'dung.pham@email.com',
          customerAddress: '321 Đường GHI, Q5, TP.HCM',
          productName: 'Màn hình LG UltraWide 34"',
          productModel: '34WP65C-B',
          productSerial: 'LG2024123456',
          productCategory: 'monitor',
          purchaseDate: '2024-02-28',
          warrantyExpiry: '2027-02-28',
          problemDescription: 'Màn hình bị flicker, xuất hiện đường kẻ dọc màu đỏ bên trái',
          productCondition: 'good',
          issueFrequency: 'frequent',
          priority: 'normal',
          status: 'rejected',
          createdAt: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString(),
          createdBy: 'Nhân viên C',
          rejectedAt: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString(),
          rejectedBy: 'Manager',
          rejectionReason: 'Hư hỏng do tác động vật lý, không thuộc phạm vi bảo hành',
          statusHistory: [
            {
              status: 'pending',
              timestamp: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString(),
              notes: 'Yêu cầu bảo hành được tạo',
              updatedBy: 'Nhân viên C'
            },
            {
              status: 'rejected',
              timestamp: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString(),
              notes: 'Từ chối bảo hành do hư hỏng vật lý',
              updatedBy: 'Manager'
            }
          ]
        }
      ];

      saveData();
    }
  }

  function saveData() {
    localStorage.setItem('warranties', JSON.stringify(warranties));
  }

  function renderWarranties() {
    const tbody = document.getElementById('warranties-tbody');
    const searchTerm = document.getElementById('search-input').value.toLowerCase();
    const statusFilter = document.getElementById('status-filter').value;
    const productFilter = document.getElementById('product-filter').value;
    const priorityFilter = document.getElementById('priority-filter').value;
    const dateFilter = document.getElementById('date-filter').value;

    let filteredWarranties = warranties.filter(warranty => {
      const matchesSearch = warranty.code.toLowerCase().includes(searchTerm) ||
                           warranty.customerName.toLowerCase().includes(searchTerm) ||
                           warranty.productName.toLowerCase().includes(searchTerm) ||
                           warranty.customerPhone.includes(searchTerm);
      const matchesStatus = statusFilter === 'all' || warranty.status === statusFilter;
      const matchesProduct = productFilter === 'all' || warranty.productCategory === productFilter;
      const matchesPriority = priorityFilter === 'all' || warranty.priority === priorityFilter;
      
      let matchesDate = true;
      if (dateFilter !== 'custom') {
        const days = parseInt(dateFilter);
        const cutoffDate = new Date(Date.now() - days * 24 * 60 * 60 * 1000);
        matchesDate = new Date(warranty.createdAt) >= cutoffDate;
      }

      return matchesSearch && matchesStatus && matchesProduct && matchesPriority && matchesDate;
    });

    if (filteredWarranties.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="8" class="px-6 py-12 text-center text-gray-500">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
            </svg>
            <h3 class="mt-2 text-sm font-medium text-gray-900">Không tìm thấy yêu cầu bảo hành nào</h3>
            <p class="mt-1 text-sm text-gray-500">Thử thay đổi bộ lọc hoặc tạo yêu cầu mới.</p>
          </td>
        </tr>
      `;
      updateStats(filteredWarranties);
      return;
    }

    let html = '';
    filteredWarranties.forEach(warranty => {
      const statusColors = {
        pending: 'bg-yellow-100 text-yellow-800',
        approved: 'bg-blue-100 text-blue-800',
        'in-progress': 'bg-orange-100 text-orange-800',
        completed: 'bg-green-100 text-green-800',
        rejected: 'bg-red-100 text-red-800',
        cancelled: 'bg-gray-100 text-gray-800'
      };

      const statusNames = {
        pending: 'Chờ xử lý',
        approved: 'Đã duyệt',
        'in-progress': 'Đang sửa',
        completed: 'Hoàn thành',
        rejected: 'Từ chối',
        cancelled: 'Đã hủy'
      };

      const priorityColors = {
        low: 'bg-gray-100 text-gray-800',
        normal: 'bg-blue-100 text-blue-800',
        high: 'bg-orange-100 text-orange-800',
        urgent: 'bg-red-100 text-red-800'
      };

      const priorityNames = {
        low: 'Thấp',
        normal: 'Bình thường',
        high: 'Cao',
        urgent: 'Khẩn cấp'
      };

      html += `
        <tr class="hover:bg-gray-50">
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${warranty.code}</td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm font-medium text-gray-900">${warranty.customerName}</div>
            <div class="text-sm text-gray-500">${warranty.customerPhone}</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm font-medium text-gray-900">${warranty.productName}</div>
            <div class="text-sm text-gray-500">${warranty.productModel || 'N/A'}</div>
          </td>
          <td class="px-6 py-4 max-w-xs">
            <div class="text-sm text-gray-900 truncate" title="${warranty.problemDescription}">
              ${warranty.problemDescription}
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="px-2 py-1 text-xs font-medium rounded-full ${priorityColors[warranty.priority]}">${priorityNames[warranty.priority]}</span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="px-2 py-1 text-xs font-medium rounded-full ${statusColors[warranty.status]}">${statusNames[warranty.status]}</span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
            ${new Date(warranty.createdAt).toLocaleDateString('vi-VN')}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
            <div class="flex space-x-2">
              <button onclick="viewWarranty('${warranty.id}')" class="text-blue-600 hover:text-blue-900">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                </svg>
              </button>
              ${warranty.status === 'pending' || warranty.status === 'approved' || warranty.status === 'in-progress' ? `
                <button onclick="updateWarrantyStatus('${warranty.id}')" class="text-green-600 hover:text-green-900">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                  </svg>
                </button>
              ` : ''}
            </div>
          </td>
        </tr>
      `;
    });

    tbody.innerHTML = html;
    updateStats(filteredWarranties);
    renderChart();
    renderTopWarrantyProducts();
  }

  function updateStats(filtered = warranties) {
    const totalWarranties = filtered.length;
    const pendingWarranties = filtered.filter(w => w.status === 'pending' || w.status === 'approved' || w.status === 'in-progress').length;
    const completedWarranties = filtered.filter(w => w.status === 'completed').length;
    
    // Calculate average processing time for completed warranties
    const completedWithTime = filtered.filter(w => w.status === 'completed' && w.completedAt);
    let avgTime = 0;
    if (completedWithTime.length > 0) {
      const totalTime = completedWithTime.reduce((sum, w) => {
        const created = new Date(w.createdAt);
        const completed = new Date(w.completedAt);
        return sum + Math.ceil((completed - created) / (1000 * 60 * 60 * 24));
      }, 0);
      avgTime = Math.round(totalTime / completedWithTime.length);
    }

    document.getElementById('total-warranties').textContent = totalWarranties;
    document.getElementById('pending-warranties').textContent = pendingWarranties;
    document.getElementById('completed-warranties').textContent = completedWarranties;
    document.getElementById('avg-time').textContent = `${avgTime} ngày`;
  }

  function renderChart() {
    const canvas = document.getElementById('warranty-chart');
    const ctx = canvas.getContext('2d');
    const period = parseInt(document.getElementById('chart-period').value);
    
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // Group warranties by date
    const dateGroups = {};
    const cutoffDate = new Date(Date.now() - period * 24 * 60 * 60 * 1000);
    
    warranties
      .filter(w => new Date(w.createdAt) >= cutoffDate)
      .forEach(warranty => {
        const date = new Date(warranty.createdAt).toLocaleDateString('vi-VN');
        if (!dateGroups[date]) {
          dateGroups[date] = { created: 0, completed: 0 };
        }
        dateGroups[date].created++;
        
        if (warranty.status === 'completed' && warranty.completedAt) {
          const completedDate = new Date(warranty.completedAt).toLocaleDateString('vi-VN');
          if (!dateGroups[completedDate]) {
            dateGroups[completedDate] = { created: 0, completed: 0 };
          }
          dateGroups[completedDate].completed++;
        }
      });

    const dates = Object.keys(dateGroups).sort((a, b) => new Date(a) - new Date(b)).slice(-7);
    if (dates.length === 0) {
      ctx.fillStyle = '#9CA3AF';
      ctx.font = '16px sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText('Không có dữ liệu', canvas.width / 2, canvas.height / 2);
      return;
    }

    const maxValue = Math.max(...dates.map(date => Math.max(dateGroups[date]?.created || 0, dateGroups[date]?.completed || 0)));
    const barWidth = canvas.width / dates.length * 0.4;

    dates.forEach((date, index) => {
      const x = index * (canvas.width / dates.length);
      const data = dateGroups[date] || { created: 0, completed: 0 };
      
      // Created bar (blue)
      const createdHeight = (data.created / maxValue) * (canvas.height * 0.6);
      ctx.fillStyle = '#3B82F6';
      ctx.fillRect(x + barWidth * 0.1, canvas.height - createdHeight - 50, barWidth * 0.4, createdHeight);
      
      // Completed bar (green)
      const completedHeight = (data.completed / maxValue) * (canvas.height * 0.6);
      ctx.fillStyle = '#10B981';
      ctx.fillRect(x + barWidth * 0.5, canvas.height - completedHeight - 50, barWidth * 0.4, completedHeight);
      
      // Date label
      ctx.fillStyle = '#374151';
      ctx.font = '12px sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText(date.split('/').slice(0, 2).join('/'), x + barWidth / 2, canvas.height - 20);
    });

    // Legend
    ctx.fillStyle = '#3B82F6';
    ctx.fillRect(20, 20, 15, 15);
    ctx.fillStyle = '#374151';
    ctx.font = '14px sans-serif';
    ctx.textAlign = 'left';
    ctx.fillText('Tạo mới', 45, 32);
    
    ctx.fillStyle = '#10B981';
    ctx.fillRect(120, 20, 15, 15);
    ctx.fillText('Hoàn thành', 145, 32);
  }

  function renderTopWarrantyProducts() {
    const container = document.getElementById('top-warranty-products');
    const productGroups = {};
    
    warranties.forEach(warranty => {
      const key = warranty.productCategory;
      if (!productGroups[key]) {
        productGroups[key] = {
          category: warranty.productCategory,
          count: 0
        };
      }
      productGroups[key].count++;
    });

    const topProducts = Object.values(productGroups)
      .sort((a, b) => b.count - a.count)
      .slice(0, 5);

    const categoryNames = {
      laptop: 'Laptop',
      desktop: 'Desktop PC',
      cpu: 'CPU',
      gpu: 'VGA Card',
      ram: 'RAM',
      storage: 'Ổ cứng',
      monitor: 'Màn hình',
      peripherals: 'Phụ kiện'
    };

    let html = '';
    topProducts.forEach((product, index) => {
      html += `
        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
          <div class="flex items-center space-x-3">
            <div class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center text-sm font-bold">
              ${index + 1}
            </div>
            <div>
              <p class="text-sm font-medium text-gray-900">${categoryNames[product.category] || product.category}</p>
            </div>
          </div>
          <div class="text-right">
            <p class="text-sm font-medium text-gray-900">${product.count} yêu cầu</p>
          </div>
        </div>
      `;
    });

    container.innerHTML = html || '<p class="text-sm text-gray-500 text-center py-4">Không có dữ liệu</p>';
  }

  window.createNewWarranty = function() {
    // Generate new warranty code
    const warrantyCount = warranties.length + 1;
    document.getElementById('warranty-code').value = `WTY-${warrantyCount.toString().padStart(3, '0')}`;
    
    // Reset form
    const form = document.getElementById('warranty-modal');
    const inputs = form.querySelectorAll('input, select, textarea');
    inputs.forEach(input => {
      if (input.id !== 'warranty-code') {
        input.value = '';
      }
    });
    
    document.getElementById('warranty-priority').value = 'normal';
    document.getElementById('product-category').value = 'laptop';
    document.getElementById('product-condition').value = 'good';
    document.getElementById('issue-frequency').value = 'sometimes';
    document.getElementById('warranty-id').value = '';
    
    document.getElementById('warranty-modal').classList.remove('hidden');
  };

  window.saveWarranty = function() {
    const code = document.getElementById('warranty-code').value;
    const customerName = document.getElementById('customer-name').value;
    const customerPhone = document.getElementById('customer-phone').value;
    const customerEmail = document.getElementById('customer-email').value;
    const customerAddress = document.getElementById('customer-address').value;
    const productName = document.getElementById('product-name').value;
    const productModel = document.getElementById('product-model').value;
    const productSerial = document.getElementById('product-serial').value;
    const productCategory = document.getElementById('product-category').value;
    const purchaseDate = document.getElementById('purchase-date').value;
    const warrantyExpiry = document.getElementById('warranty-expiry').value;
    const problemDescription = document.getElementById('problem-description').value;
    const productCondition = document.getElementById('product-condition').value;
    const issueFrequency = document.getElementById('issue-frequency').value;
    const priority = document.getElementById('warranty-priority').value;

    if (!customerName || !customerPhone || !productName || !problemDescription) {
      alert('Vui lòng điền đầy đủ thông tin bắt buộc!');
      return;
    }

    // Phone validation
    const phoneRegex = /^[0-9]{10,11}$/;
    if (!phoneRegex.test(customerPhone.replace(/[\s-]/g, ''))) {
      alert('Số điện thoại không hợp lệ!');
      return;
    }

    const warranty = {
      id: 'wty_' + Date.now(),
      code,
      customerName,
      customerPhone,
      customerEmail,
      customerAddress,
      productName,
      productModel,
      productSerial,
      productCategory,
      purchaseDate,
      warrantyExpiry,
      problemDescription,
      productCondition,
      issueFrequency,
      priority,
      status: 'pending',
      createdAt: new Date().toISOString(),
      createdBy: 'Admin User',
      statusHistory: [
        {
          status: 'pending',
          timestamp: new Date().toISOString(),
          notes: 'Yêu cầu bảo hành được tạo',
          updatedBy: 'Admin User'
        }
      ]
    };

    warranties.unshift(warranty);
    saveData();
    closeModal('warranty-modal');
    renderWarranties();
    alert('Đã tạo yêu cầu bảo hành thành công!');
  };

  window.viewWarranty = function(warrantyId) {
    const warranty = warranties.find(w => w.id === warrantyId);
    if (!warranty) return;

    currentWarranty = warranty;

    const statusNames = {
      pending: 'Chờ xử lý',
      approved: 'Đã duyệt',
      'in-progress': 'Đang sửa chữa',
      completed: 'Hoàn thành',
      rejected: 'Từ chối',
      cancelled: 'Đã hủy'
    };

    const priorityNames = {
      low: 'Thấp',
      normal: 'Bình thường',
      high: 'Cao',
      urgent: 'Khẩn cấp'
    };

    const categoryNames = {
      laptop: 'Laptop',
      desktop: 'Desktop PC',
      cpu: 'CPU',
      gpu: 'VGA Card',
      ram: 'RAM',
      storage: 'Ổ cứng',
      monitor: 'Màn hình',
      peripherals: 'Phụ kiện'
    };

    let statusHistoryHtml = '';
    warranty.statusHistory.forEach(history => {
      statusHistoryHtml += `
        <div class="border-l-4 border-blue-400 pl-4 py-2">
          <div class="flex justify-between items-start">
            <div>
              <p class="text-sm font-medium text-gray-900">${statusNames[history.status]}</p>
              <p class="text-sm text-gray-600">${history.notes}</p>
            </div>
            <div class="text-right">
              <p class="text-xs text-gray-500">${new Date(history.timestamp).toLocaleString('vi-VN')}</p>
              <p class="text-xs text-gray-500">bởi ${history.updatedBy}</p>
            </div>
          </div>
        </div>
      `;
    });

    const html = `
      <div class="space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <h4 class="font-semibold text-gray-900 mb-3">Thông tin khách hàng</h4>
            <div class="space-y-2 text-sm">
              <div><strong>Tên khách hàng:</strong> ${warranty.customerName}</div>
              <div><strong>Điện thoại:</strong> <a href="tel:${warranty.customerPhone}" class="text-blue-600">${warranty.customerPhone}</a></div>
              ${warranty.customerEmail ? `<div><strong>Email:</strong> <a href="mailto:${warranty.customerEmail}" class="text-blue-600">${warranty.customerEmail}</a></div>` : ''}
              ${warranty.customerAddress ? `<div><strong>Địa chỉ:</strong> ${warranty.customerAddress}</div>` : ''}
            </div>
          </div>
          <div>
            <h4 class="font-semibold text-gray-900 mb-3">Thông tin bảo hành</h4>
            <div class="space-y-2 text-sm">
              <div><strong>Mã bảo hành:</strong> ${warranty.code}</div>
              <div><strong>Ưu tiên:</strong> <span class="px-2 py-1 text-xs rounded-full ${getPriorityColor(warranty.priority)}">${priorityNames[warranty.priority]}</span></div>
              <div><strong>Trạng thái:</strong> <span class="px-2 py-1 text-xs rounded-full ${getStatusColor(warranty.status)}">${statusNames[warranty.status]}</span></div>
              <div><strong>Ngày tạo:</strong> ${new Date(warranty.createdAt).toLocaleString('vi-VN')}</div>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <h4 class="font-semibold text-gray-900 mb-3">Thông tin sản phẩm</h4>
            <div class="space-y-2 text-sm">
              <div><strong>Tên sản phẩm:</strong> ${warranty.productName}</div>
              ${warranty.productModel ? `<div><strong>Model:</strong> ${warranty.productModel}</div>` : ''}
              ${warranty.productSerial ? `<div><strong>Serial:</strong> ${warranty.productSerial}</div>` : ''}
              <div><strong>Loại:</strong> ${categoryNames[warranty.productCategory] || warranty.productCategory}</div>
              ${warranty.purchaseDate ? `<div><strong>Ngày mua:</strong> ${new Date(warranty.purchaseDate).toLocaleDateString('vi-VN')}</div>` : ''}
              ${warranty.warrantyExpiry ? `<div><strong>Hết hạn BH:</strong> ${new Date(warranty.warrantyExpiry).toLocaleDateString('vi-VN')}</div>` : ''}
            </div>
          </div>
          <div>
            <h4 class="font-semibold text-gray-900 mb-3">Chi tiết vấn đề</h4>
            <div class="space-y-2 text-sm">
              <div><strong>Tình trạng:</strong> ${warranty.productCondition}</div>
              <div><strong>Tần suất:</strong> ${warranty.issueFrequency}</div>
              ${warranty.repairCost !== undefined ? `<div><strong>Chi phí sửa:</strong> ${formatVND(warranty.repairCost)}</div>` : ''}
              ${warranty.replacedParts ? `<div><strong>Linh kiện thay:</strong> ${warranty.replacedParts}</div>` : ''}
            </div>
          </div>
        </div>

        <div>
          <h4 class="font-semibold text-gray-900 mb-2">Mô tả vấn đề</h4>
          <p class="text-sm text-gray-600 bg-gray-50 p-3 rounded-md">${warranty.problemDescription}</p>
        </div>

        ${warranty.rejectionReason ? `
          <div>
            <h4 class="font-semibold text-gray-900 mb-2">Lý do từ chối</h4>
            <p class="text-sm text-red-600 bg-red-50 p-3 rounded-md">${warranty.rejectionReason}</p>
          </div>
        ` : ''}

        <div>
          <h4 class="font-semibold text-gray-900 mb-3">Lịch sử xử lý</h4>
          <div class="space-y-3">
            ${statusHistoryHtml}
          </div>
        </div>
      </div>
    `;

    document.getElementById('warranty-detail-title').textContent = `Chi tiết bảo hành ${warranty.code}`;
    document.getElementById('warranty-detail-content').innerHTML = html;
    
    // Show/hide action buttons based on status
    const approveBtn = document.getElementById('approve-warranty-btn');
    const updateBtn = document.getElementById('update-status-btn');
    
    if (warranty.status === 'pending') {
      approveBtn.classList.remove('hidden');
      updateBtn.classList.remove('hidden');
    } else if (warranty.status === 'approved' || warranty.status === 'in-progress') {
      approveBtn.classList.add('hidden');
      updateBtn.classList.remove('hidden');
    } else {
      approveBtn.classList.add('hidden');
      updateBtn.classList.add('hidden');
    }

    // Set up button events
    approveBtn.onclick = () => approveWarranty(warranty.id);
    updateBtn.onclick = () => updateWarrantyStatus(warranty.id);
    
    document.getElementById('warranty-detail-modal').classList.remove('hidden');
  };

  window.approveWarranty = function(warrantyId) {
    if (!confirm('Bạn có chắc chắn muốn duyệt yêu cầu bảo hành này?')) return;

    const warranty = warranties.find(w => w.id === warrantyId);
    if (warranty) {
      warranty.status = 'approved';
      warranty.approvedAt = new Date().toISOString();
      warranty.approvedBy = 'Admin User';
      
      warranty.statusHistory.push({
        status: 'approved',
        timestamp: new Date().toISOString(),
        notes: 'Yêu cầu bảo hành đã được duyệt',
        updatedBy: 'Admin User'
      });

      saveData();
      closeModal('warranty-detail-modal');
      renderWarranties();
      alert('Đã duyệt yêu cầu bảo hành thành công!');
    }
  };

  window.updateWarrantyStatus = function(warrantyId) {
    const warranty = warranties.find(w => w.id === warrantyId);
    if (!warranty) return;

    document.getElementById('updating-warranty-id').value = warrantyId;
    document.getElementById('new-status').value = getNextStatus(warranty.status);
    document.getElementById('status-notes').value = '';
    document.getElementById('repair-cost').value = '';
    document.getElementById('replaced-parts').value = '';
    
    // Show/hide completion fields
    const completionFields = document.getElementById('completion-fields');
    if (getNextStatus(warranty.status) === 'completed') {
      completionFields.classList.remove('hidden');
    } else {
      completionFields.classList.add('hidden');
    }
    
    document.getElementById('update-status-modal').classList.remove('hidden');
  };

  // Show/hide completion fields when status changes
  document.getElementById('new-status').addEventListener('change', function() {
    const completionFields = document.getElementById('completion-fields');
    if (this.value === 'completed') {
      completionFields.classList.remove('hidden');
    } else {
      completionFields.classList.add('hidden');
    }
  });

  window.submitStatusUpdate = function() {
    const warrantyId = document.getElementById('updating-warranty-id').value;
    const newStatus = document.getElementById('new-status').value;
    const notes = document.getElementById('status-notes').value;
    const repairCost = parseFloat(document.getElementById('repair-cost').value) || 0;
    const replacedParts = document.getElementById('replaced-parts').value;

    if (!notes) {
      alert('Vui lòng nhập ghi chú cập nhật!');
      return;
    }

    const warranty = warranties.find(w => w.id === warrantyId);
    if (warranty) {
      warranty.status = newStatus;
      
      if (newStatus === 'completed') {
        warranty.completedAt = new Date().toISOString();
        warranty.repairCost = repairCost;
        warranty.replacedParts = replacedParts;
      } else if (newStatus === 'rejected') {
        warranty.rejectedAt = new Date().toISOString();
        warranty.rejectedBy = 'Admin User';
        warranty.rejectionReason = notes;
      }
      
      warranty.statusHistory.push({
        status: newStatus,
        timestamp: new Date().toISOString(),
        notes: notes,
        updatedBy: 'Admin User'
      });

      saveData();
      closeModal('update-status-modal');
      closeModal('warranty-detail-modal');
      renderWarranties();
      alert('Đã cập nhật trạng thái bảo hành thành công!');
    }
  };

  function getNextStatus(currentStatus) {
    const statusFlow = {
      'pending': 'approved',
      'approved': 'in-progress',
      'in-progress': 'completed'
    };
    return statusFlow[currentStatus] || 'completed';
  }

  function getStatusColor(status) {
    const colors = {
      pending: 'bg-yellow-100 text-yellow-800',
      approved: 'bg-blue-100 text-blue-800',
      'in-progress': 'bg-orange-100 text-orange-800',
      completed: 'bg-green-100 text-green-800',
      rejected: 'bg-red-100 text-red-800',
      cancelled: 'bg-gray-100 text-gray-800'
    };
    return colors[status] || '';
  }

  function getPriorityColor(priority) {
    const colors = {
      low: 'bg-gray-100 text-gray-800',
      normal: 'bg-blue-100 text-blue-800',
      high: 'bg-orange-100 text-orange-800',
      urgent: 'bg-red-100 text-red-800'
    };
    return colors[priority] || '';
  }

  window.exportWarranties = function() {
    const csvContent = generateWarrantyCSV(warranties);
    downloadCSV(csvContent, `warranties-${new Date().toISOString().split('T')[0]}.csv`);
  };

  function generateWarrantyCSV(data) {
    const headers = ['Mã BH', 'Khách hàng', 'Điện thoại', 'Sản phẩm', 'Vấn đề', 'Ưu tiên', 'Trạng thái', 'Ngày tạo', 'Ngày hoàn thành'];
    
    const statusNames = {
      pending: 'Chờ xử lý',
      approved: 'Đã duyệt',
      'in-progress': 'Đang sửa chữa',
      completed: 'Hoàn thành',
      rejected: 'Từ chối',
      cancelled: 'Đã hủy'
    };

    const priorityNames = {
      low: 'Thấp',
      normal: 'Bình thường',
      high: 'Cao',
      urgent: 'Khẩn cấp'
    };
    
    const rows = data.map(warranty => [
      warranty.code,
      warranty.customerName,
      warranty.customerPhone,
      warranty.productName,
      warranty.problemDescription.substring(0, 100) + '...',
      priorityNames[warranty.priority],
      statusNames[warranty.status],
      new Date(warranty.createdAt).toLocaleDateString('vi-VN'),
      warranty.completedAt ? new Date(warranty.completedAt).toLocaleDateString('vi-VN') : ''
    ]);

    return [headers, ...rows].map(row => 
      row.map(field => `"${field}"`).join(',')
    ).join('\n');
  }

  function downloadCSV(content, filename) {
    const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', filename);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }

  window.refreshWarranties = function() {
    renderWarranties();
    alert('Đã làm mới danh sách bảo hành!');
  };

  window.closeModal = function(modalId) {
    document.getElementById(modalId).classList.add('hidden');
  };

  function formatVND(amount) {
    return new Intl.NumberFormat('vi-VN', {
      style: 'currency',
      currency: 'VND'
    }).format(amount);
  }

  // Event listeners
  document.getElementById('search-input').addEventListener('input', renderWarranties);
  document.getElementById('status-filter').addEventListener('change', renderWarranties);
  document.getElementById('product-filter').addEventListener('change', renderWarranties);
  document.getElementById('priority-filter').addEventListener('change', renderWarranties);
  document.getElementById('date-filter').addEventListener('change', function() {
    const customRange = document.getElementById('custom-date-range');
    if (this.value === 'custom') {
      customRange.classList.remove('hidden');
    } else {
      customRange.classList.add('hidden');
      renderWarranties();
    }
  });
  document.getElementById('chart-period').addEventListener('change', renderChart);

  // Initialize
  loadSampleData();
  renderWarranties();
});
</script>

<style>
.form-input, .form-select, .form-textarea {
  @apply px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 w-full;
}

.modal-overlay {
  @apply fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50;
}

.modal-content {
  @apply bg-white rounded-lg shadow-xl w-full mx-4 max-h-screen overflow-y-auto;
}

.modal-header {
  @apply flex items-center justify-between p-6 border-b;
}

.modal-title {
  @apply text-lg font-medium text-gray-900;
}

.modal-close {
  @apply text-gray-400 hover:text-gray-600 text-2xl font-bold cursor-pointer;
}

.modal-body {
  @apply p-6;
}

.modal-footer {
  @apply flex items-center justify-end space-x-3 p-6 border-t bg-gray-50;
}

.btn {
  @apply px-4 py-2 rounded-md font-medium focus:outline-none focus:ring-2 focus:ring-offset-2;
}

.btn-primary {
  @apply bg-blue-600 text-white hover:bg-blue-700 focus:ring-blue-500;
}

.btn-secondary {
  @apply bg-gray-200 text-gray-900 hover:bg-gray-300 focus:ring-gray-500;
}

.btn-success {
  @apply bg-green-600 text-white hover:bg-green-700 focus:ring-green-500;
}

.form-label {
  @apply block text-sm font-medium text-gray-700 mb-1;
}
</style>